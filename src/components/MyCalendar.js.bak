//MyCalendar.js => 메인캘린더 담당
import _ from 'lodash';
import React, { useState, useRef } from 'react';
import { StatusBar } from 'expo-status-bar';
import {Platform, Button, TextInput,Dimensions, View, Text,   Modal, TouchableOpacity, StyleSheet} from 'react-native';
import {ExpandableCalendar, AgendaList, CalendarProvider, WeekCalendar, LocaleConfig, CalendarList, Agenda} from 'react-native-calendars';
import DropDownPicker from 'react-native-dropdown-picker';
import Calendar from '../react-native-calendars/src/calendar/index'
import DatePicker from 'react-native-datepicker';
import Icon from 'react-native-vector-icons/FontAwesome'; // 아이콘 라이브러리 import

const boxNames = [ //자격증 리스트
{ label: "펀드투자권유자문인력", value: "펀드투자권유자문인력" },
{ label: "파생상품투자권유자문인력", value: "파생상품투자권유자문인력" },
{ label: "생명보험대리점", value: "생명보험대리점" },
{ label: "제3보험", value: "제3보험" },
{ label: "손해보험대리점", value: "손해보험대리점" },
{ label: "신용분석사", value: "신용분석사" },
{ label: "ADsP", value: "ADsP" },
{ label: "SQLD", value: "SQLD" },
{ label: "COS", value: "COS" },
{ label: "COS PRO", value: "COS PRO" },
{ label: "토익", value: "토익" },
{ label: "토스", value: "토스" },
];
const COLORS = [
    "#B8A6DF", // Pale Purple
    "#F791B6", // Soft Pink
    "#89CDD9", // Pale Aqua
    "#FBA58D", // Coral
    "#9ED6A1", // Pale Green
    "#FFB884", // Apricot
    "#FAC98A", // Peach
    "#CDA2D9", // Lavender
    "#9BCBF6", // Powder Blue
    "#FFCFA6", // Pale Orange
    "#FFC107", // Amber
    "#C4E9B5", // Pale Greenish
];
LocaleConfig.locales['ko'] = {
    monthNames: ['1월', '2월', '3월', '4월', '5월', '6월', '7월', '8월', '9월', '10월', '11월', '12월'],
    monthNamesShort: ['1월', '2월', '3월', '4월', '5월', '6월', '7월', '8월', '9월', '10월', '11월', '12월'],
    dayNames: ['일요일', '월요일', '화요일', '수요일', '목요일', '금요일', '토요일'],
    dayNamesShort: ['일', '월', '화', '수', '목', '금', '토'],
    today: '오늘'
  };
LocaleConfig.defaultLocale = 'ko';
export default function MyCalendar() {
  // Declare and initialize selectedDay state variable
  //selectedDay는 상태함수
  const [selectedDay, setSelectedDay] = useState(null);
  const [modalVisible, setModalVisible] = useState(false);
  const [additionalModalVisible, setAdditionalModalVisible] = useState(false);
  const [startDate, setStartDate] = useState(null);
  const [endDate, setEndDate] = useState(null);
  const [datePickerVisible, setDatePickerVisible] = useState(false);
  const calendarRef = useRef(null); // Ref to access the Calendar component
  const [markedDates, setMarkedDates] = useState({});
  const [eventTitle, setEventTitle] = useState({}); // 일정 제목 상태 변수 추가
  const [colorIndex, setColorIndex] = useState(0); // 현재 색상 인덱스 상태 변수 추가
  const [open, setOpen] = useState(false);
  const [value, setValue] = useState(null);
  const [items, setItems] = useState([]);
  const [selectedBox, setSelectedBox] = useState(null);
  const [selectedCertificates, setSelectedCertificates] = useState([]); // 선택한 자격증 이름들을 저장할 상태 변수
  const handleCertificateSelect = (selectedValue) => {
    setEventTitle(selectedValue); // 선택한 자격증명을 eventTitle 상태로 설정
  
    if (selectedDay) {
      const updatedCertificateEvents = { ...certificateEvents };
  
      if (!updatedCertificateEvents[selectedDay]) {
        updatedCertificateEvents[selectedDay] = [];
      }
  
      // 선택한 자격증 명을 해당 날짜의 일정에 추가
      updatedCertificateEvents[selectedDay].push(selectedValue);
  
      setCertificateEvents(updatedCertificateEvents);
    }
  };
  const [certificateEvents, setCertificateEvents] = useState({});
  
  
  const handleAddEventPress = () => {
    setAdditionalModalVisible(true);
    setDatePickerVisible(true);
  };
  
// DatePicker에서 선택한 시작 날짜와 종료 날짜를 처리하는 함수
  const handleConfirmDatePicker = (startDate, endDate) => {
  const start = new Date(startDate);
  const end = new Date(endDate);
  const datesRange = getDatesRange(start, end);

  const updatedMarkedDates = { ...markedDates };

  const colorPosition = Object.values(updatedMarkedDates).length > 0
    ? Object.values(updatedMarkedDates)[0].periods.length
    : 0;


  // 사이의 날짜를 표시
  datesRange.forEach((date) => {
    const dateString = formatDate(date);
    if (!updatedMarkedDates[dateString]) {
      updatedMarkedDates[dateString] = { periods: [] };
    }
    
    for (let i = updatedMarkedDates[dateString].periods.length; i < colorPosition; i++) {
      updatedMarkedDates[dateString].periods.push({ color: 'transparent' });
    }

    updatedMarkedDates[dateString].periods.push({ color: COLORS[colorIndex] });
  });

  setMarkedDates(updatedMarkedDates);
  setStartDate(null);
  setEndDate(null);
  setAdditionalModalVisible(false);
  // 다음 색상 인덱스로 업데이트
  setColorIndex((colorIndex + 1) % COLORS.length);
};

  // 시작 날짜부터 종료 날짜까지의 모든 날짜를 배열로 반환하는 함수
  const getDatesRange = (startDate, endDate) => {
    const datesRange = [];
    const currentDate = new Date(startDate);
  
    while (currentDate <= endDate) {
      datesRange.push(new Date(currentDate));
      currentDate.setDate(currentDate.getDate() + 1);
    }
  
    return datesRange;
  };

  // 날짜를 'yyyy-MM-dd' 형식의 문자열로 변환하는 함수
  const formatDate = (date) => {
    const year = date.getFullYear();
    const month = String(date.getMonth() + 1).padStart(2, '0');
    const day = String(date.getDate()).padStart(2, '0');
    return `${year}-${month}-${day}`;
  };

  // 선택한 날짜
  const selectedDate = selectedDay ? new Date(selectedDay) : null;
  const selectedMonth = selectedDate ? selectedDate.getMonth() : null;

  // 오늘 날짜
  const DATE = new Date(); //오늘 날짜
  const YEAR = DATE.getFullYear();  //오늘 날짜의 연도
  const MONTH = DATE.getMonth() + 1;  //오늘 날짜의 월
  const DAY = DATE.getDate();  //오늘 날짜의 일
  const today = { year: YEAR, month: MONTH, date: DAY };
  const dateString = YEAR + '-' + MONTH  + '-' + DAY;

  const handleDayPress = (day) => {
    setSelectedDay(day.dateString);
    setModalVisible(true);
  };
  const [currentMonth, setCurrentMonth] = useState('');

  // 현재 보이는 달(months)이 변경될 때 호출되는 콜백 함수
  const handleVisibleMonthsChange = (months) => {
    setCurrentMonth(months[0]);
  };



  return (
      <View style={{ height: 600, flex: 1, justifyContent: 'center', alignItems: 'center' }}>
        <Calendar
          ref={calendarRef}
          useNativeDriver={true} 
          monthFormat={'yyyy'+'년 '+'MM'+'월'}
          hideExtraDays={false}
          horizontal={true} //가로로 스와이프
          hideArrows={false}
          pagingEnabled={true} // 가로로 페이지 단위로 스와이프
          style={{
            borderWidth: 1,
            borderColor: 'gray',
            height: Dimensions.get('window').height * 0.9, //화면비율설정
            width: Dimensions.get('window').width,
            fontFamily: 'System',
          }}
          onDayPress={handleDayPress} // 팝업 창을 열기 위한 이벤트 핸들러 추가
          markingType="multi-period"
          markedDates={markedDates}
          onVisibleMonthsChange={handleVisibleMonthsChange} // 현재 보이는 달(months)이 변경될 때 호출되는 콜백 함수
        />
      {/* 일정 추가 버튼 */}
      <TouchableOpacity
        onPress={handleAddEventPress}
        style={{
          position: 'absolute',
          bottom: 20,
          right: 20,
          backgroundColor: 'pink',
          padding: 10,
          borderRadius: 30,
          elevation: 5,
        }}
      >
        <Icon name="plus" size={24} color="white" />
      </TouchableOpacity>

      <Modal
        visible={modalVisible}
        onRequestClose={() => {
            setModalVisible(false);
        }}
        transparent={true}
        >
        <View style={styles.modalContainer}>
            <View style={styles.modalContent}>
            <Text style={styles.modalTitle} numberOfLines={1}>
                {selectedDay}
            </Text>
            {markedDates[selectedDay] && eventTitle ? (
                <>
                {Object.keys(markedDates[selectedDay]).map((key, index) => (
                    <Text key={index} style={styles.modalItem}>
                    {markedDates[selectedDay][key].map((period, periodIndex) => (
                        <Text
                        key={periodIndex}
                        style={{ backgroundColor: period.color, padding: 2 }}
                        >
                        {period.title}
                        </Text>
                    ))}
                    </Text>
                ))}
                </>
            ) : null}
            
            {selectedDay && certificateEvents[selectedDay] ? (
                <View style={styles.modalCertificateList}>
                <Text style={styles.modalCertificateListTitle}>자격증 목록</Text>
                {certificateEvents[selectedDay].map((certificate, index) => (
                    <Text key={index} style={styles.modalCertificateListItem}>
                    {certificate}
                    </Text>
                ))}
                </View>
            ) : null}
            
            <TouchableOpacity
                onPress={() => setModalVisible(false)}
                style={styles.modalButton}
            >
                <Text style={styles.modalButtonText}>닫기</Text>
            </TouchableOpacity>
            </View>
        </View>
        </Modal>

      {/* 추가 모달 */}
      <Modal
        visible={additionalModalVisible}
        onRequestClose={() => {
          setAdditionalModalVisible(false);
        }}
        transparent={true}
      >
        {/* 추가 모달의 컨텐츠를 구현하세요 */}
        <View style={styles.additionalModalContainer}>
          <View style={styles.additionalModalContent}>
            <Text style={styles.additionalModalTitle}>일정 추가</Text>

            <View style={[styles.inputTitleContainer, { marginTop: 10, zIndex: 100 }]}>
            <DropDownPicker
            open={open}
            value={eventTitle} // eventTitle 상태 값을 value prop에 설정
            setValue={(selectedValue) => handleCertificateSelect(selectedValue)}
            items={boxNames.map((name, index) => ({
                label: name.label,
                value: name.value,
            }))}
            setOpen={setOpen}
            placeholder="자격증 선택"
            containerStyle={{ height: 40, width: '100%', zIndex: 100 }}
            style={{ backgroundColor: '#fafafa' }}
            dropDownStyle={{ backgroundColor: '#fafafa' }}
            />
            </View>

            {datePickerVisible && ( // datePickerVisible이 true일 때만 DatePicker 컴포넌트를 표시
              <>
            <View style={[styles.inputContainer, { marginBottom: 10 }]}>
            <DatePicker
              style={[styles.datePicker, { marginTop: 0 }]} // marginTop 값을 0으로 설정
              date={startDate}
              mode="date"
              placeholder="시작 날짜"
              format="YYYY-MM-DD"
              minDate={dateString}
              maxDate="2024-06-30"
              confirmBtnText="확인"
              cancelBtnText="취소"
              customStyles={{
                dateIcon: {
                  display: 'none',
                },
                dateInput: {
                  borderWidth: 0, // DatePicker 내부의 border 제거
                  padding: 0, // DatePicker 내부의 padding 제거
                  width: '100%', // DatePicker가 전체 너비를 차지하도록 설정
                  height: 40,
                  textAlign: 'left', // 텍스트를 왼쪽으로 정렬
                },  
              }}
              onDateChange={(date) => setStartDate(date)}
            />
            </View>

            <View style={[styles.inputContainer, { marginBottom: 10 }]}>
            <DatePicker
              style={[styles.datePicker, { marginTop: 0 }]} // marginTop 값을 0으로 설정
              date={endDate}
              mode="date"
              placeholder="종료 날짜"
              format="YYYY-MM-DD"
              minDate={startDate}
              maxDate="2024-06-30"
              confirmBtnText="확인"
              cancelBtnText="취소"
              customStyles={{
                dateIcon: {
                  display: 'none',
                },
                dateInput: {
                  borderWidth: 0, // DatePicker 내부의 border 제거
                  padding: 0, // DatePicker 내부의 padding 제거
                  width: '100%', // DatePicker가 전체 너비를 차지하도록 설정
                  height: 40,
                  textAlign: 'left', // 텍스트를 왼쪽으로 정렬
                },
                confirmBtnContainer: {
                  position: 'absolute',
                  right: 70, // 확인 버튼 위치 조정
                },
                cancelBtnContainer: {
                  position: 'absolute',
                  right: 0, // 취소 버튼 위치 조정
                },
                btnTextConfirm: {
                  color: 'blue', // 확인 버튼 텍스트 색상 설정
                },
                btnTextCancel: {
                  color: 'red', // 취소 버튼 텍스트 색상 설정
                },
              }}
              onDateChange={(date) => setEndDate(date)}
            />
            </View>

          <TouchableOpacity
            onPress={() => handleConfirmDatePicker(startDate, endDate)}
            style={styles.additionalModalButton}
          >
            <Text style={styles.additionalModalButtonText}>확인</Text>
          </TouchableOpacity>
          </>
          )}

            <TouchableOpacity
              onPress={() => setAdditionalModalVisible(false)}
              style={styles.additionalModalButton}
            >
              <Text style={styles.additionalModalButtonText}>닫기</Text>
            </TouchableOpacity>
          </View>
        </View>
      </Modal>

      <StatusBar style="auto" />
    </View>
    
  );
}


//화면 크기에 비례로 디자인 적용하기 위해 실행
const screenHeight = Dimensions.get('window').height;
const screenWidth = Dimensions.get('window').width;

const styles = StyleSheet.create({
  //달력 맨 윗줄(sun mon...)과 첫 주 칸 조정
  headerContainer: {
    marginTop: -10, // 맨 윗줄과 첫 주 칸 간의 간격 조정
  },
  week: {
    marginBottom: -10, // 맨 윗줄과 첫 주 칸 간의 간격 조정
  },
  //일자 컨테이너 스타일 조정
  dayContainer: {
    flex: 1,
    justifyContent: 'center',
    alignItems: 'center',
    //칸 크기 조정하는 부분 padding
    paddingBottom: 40,
    paddingHorizontal: screenWidth*0.01,
    marginTop : 0,
    marginBottom: 0,
    borderColor: '#000', // 테두리 색상 설정
    borderWidth: 2, // 테두리 두께를 1로 설정
    borderRadius: 5, // 테두리의 둥근 정도를 설정 (옵션)
  },
  dayTextContainer: {
    width: 30, // Adjust these values as per your design
    height: 30, // Adjust these values as per your design
    justifyContent: 'center',
    alignItems: 'center',
    borderColor: '#d094ea', // 테두리 색상 설정
    borderWidth: 2, // 테두리 두께를 1로 설정
    borderRadius: 5, // 테두리의 둥근 정도를 설정 (옵션)
  },
  dayText: {
    fontSize: 10,
    fontWeight: 'normal',
    color: 'black',
  },
  disabledDayText: {
    color: 'lightgray',
  },
  currentDate: {
    color: 'white',
    fontWeight: 'bold',
    backgroundColor: 'purple', // 테두리 색상 설정
    borderRadius: 5, // 테두리의 둥근 정도를 설정 (옵션)
    padding: 5,
  },

  modalContainer: {
    flex: 1,
    justifyContent: 'center',
    alignItems: 'center',
    backgroundColor: 'rgba(0, 0, 0, 0.5)',
  },
  modalContent: {
    backgroundColor: '#fff',
    padding: 20,
    borderRadius: 10,
    alignItems: 'center',
    width: '80%',
    maxHeight: '80%', // 추가된 속성
    maxWidth: '90%',
  },
  modalTitle: {
    fontSize: 18,
    fontWeight: 'bold',
    marginBottom: 10,
    maxHeight: '80%',
    maxWidth: '90%', // 추가된 속성
  },
  modalItem: {
    fontSize: 15,
    marginBottom: 10,
  },
  modalButton: {
    backgroundColor: '#007AFF',
    padding: 10,
    borderRadius: 5,
    marginTop: 20,
  },
  modalButtonText: {
    color: '#fff',
    fontSize: 18,
  },

  additionalModalContainer: {
    flex: 1,
    justifyContent: 'center',
    alignItems: 'center',
    backgroundColor: 'rgba(0, 0, 0, 0.5)',
  },
  additionalModalContent: {
    backgroundColor: '#fff',
    padding: 20,
    borderRadius: 10,
    alignItems: 'center',
    width: '80%',
    maxHeight: '80%', // 추가된 속성
    maxWidth: '90%',
    alignItems: 'center', // 버튼들을 수직 중앙 정렬
  },
  
  additionalModalTitle: {
    fontSize: 18,
    fontWeight: 'bold',
    marginBottom: 10,
    maxHeight: '80%',
    maxWidth: '90%', // 추가된 속성
  },
  additionalModalItem: {
    fontSize: 15,
    marginBottom: 10,
  },
  additionalModalButton: {
    backgroundColor: '#007AFF',
    padding: 10,
    borderRadius: 5,
    marginTop: 20,
  },
  additionalModalButtonText: {
    color: '#fff',
    fontSize: 18,
  },
  inputContainer: {
    borderWidth: 1,
    borderColor: 'black',
    borderRadius: 5,
    backgroundColor: '#fafafa',
    alignItems: 'center',
    padding: 5,
    width: 290, // 원하는 너비 설정
    height: 50,
  },
  inputTitleContainer: {
    height: 60, // 적절한 높이로 설정
    // 추가적인 스타일 속성들
  },
  container: {
    flex: 1,
    backgroundColor: '#fff',
    alignItems: 'center',
    justifyContent: 'center',
  },

});